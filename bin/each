#!/usr/bin/env bash

[[ $# -lt 1 ]] && echo "Usage: $0 <cmd>" && exit 1

CMD="${@}"
RETURN=0

for PACKAGE in $(find src/*/composer.json -type f); do
    DIR="$(dirname ${PACKAGE})"
    pushd "${DIR}" &> /dev/null
    LABEL="Running in \"${DIR}\""
    if [[ ${TRAVIS} = true ]]; then
        tfold "${LABEL}" "${CMD}"
    else
        echo -e "\e[34m${LABEL}\e[0m"
        bash -xc "${CMD}" 2>&1
    fi
    [[ $? -ne 0 ]] && RETURN=$?
    popd &> /dev/null
done

exit ${RETURN}
