#!/usr/bin/env bash

source bin/.bashrc
[[ $# -ne 3 ]] && label "Usage: $0 <major> <minor> <patch>" ko && exit 1

assert_clean

curr_version="$(git describe --abbrev=0 --tags)"
next_version="v$1.$2.$3"
[[ ${curr_version} == ${next_version} ]] && label "Invalid version" ko && exit 1

label "1. SMOKE TEST"
bin/smoke-test
[[ $? -ne 0 ]] && label "Failed" ko && exit 1

label "2. BUILD DOCS"
bin/build-docs
[[ $? -ne 0 ]] && label "Failed" ko && exit 1

assert_clean

confirm "Release ${curr_version} -> ${next_version}?"
[[ $? -ne 1 ]] && label "Aborted" ok && exit

git tag -sm enjoy "${next_version}"

label "Done" ok
